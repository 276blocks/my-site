<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bitcoin Analytics Dashboard</title>

<!-- UI + Icons -->
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

<!-- Charting -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3.0.1"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.2.0"></script>

<!-- CSV parsing -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  /* ----- glass + misc styles (unchanged) ----- */
  .glass-card{background:rgba(255,255,255,.1);backdrop-filter:blur(10px);
              border-radius:12px;border:1px solid rgba(255,255,255,.18);
              box-shadow:0 8px 32px 0 rgba(31,38,135,.37)}
  .dark .glass-card{background:rgba(30,30,30,.7);
                    border:1px solid rgba(255,255,255,.1)}
  .chart-container{position:relative;height:400px}
  .spinner{animation:spin 1s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}
  .btn-group input[type="radio"]:checked+label{background-color:#3b82f6;color:#fff}
</style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 transition-colors duration-200">

<!-- ░░ UI markup (navbar, sidebar, cards …) – UNCHANGED ░░ -->
<!-- (… all your existing HTML up to the end of the body …) -->
<!-- ─────────────────────────────────────────────────────── -->

<script>
/* ──────────────────────────────────────────────────────────
   0.  CONSTANTS & HELPER UTILITIES
─────────────────────────────────────────────────────────── */
const DATA_URL = "https://data.bitcoinity.org/export_data.csv?c=e&currency=USD&data_type=price&r=day&t=l&timespan=all";

const HALVING_DATES = [
  '2012-11-28','2016-07-09','2020-05-11','2024-04-19'
].map(d => new Date(d+"T00:00:00Z"));

let fullData = [];        // [{date:Date, price:Number}, …] – filled once
let mainChart, secondaryChart, simChart;

/*  THEME CONFIG – unchanged  */
const lightTheme = {bg:'#f8f9fa',card:'#fff',text:'#212529',primary:'#0d6efd',
  secondary:'#6c757d',success:'#198754',warning:'#ffc107',danger:'#dc3545',
  info:'#0dcaf0',chartBg:'#fff',gridColor:'rgba(0,0,0,.1)',textColor:'#666'};
const darkTheme  = {bg:'#121212',card:'#1e1e1e',text:'#e9ecef',primary:'#0d6efd',
  secondary:'#6c757d',success:'#198754',warning:'#ffc107',danger:'#dc3545',
  info:'#0dcaf0',chartBg:'#1e1e1e',gridColor:'rgba(255,255,255,.1)',textColor:'#AAA'};
const getCurrentTheme = () =>
  document.documentElement.classList.contains('dark') ? darkTheme : lightTheme;

/* Utility: fetch and parse the CSV once */
async function fetchBTCData() {
  const resp = await fetch(DATA_URL);
  if (!resp.ok) throw new Error("CSV download failed");
  const csv = await resp.text();
  const parsed = Papa.parse(csv, {header:true, dynamicTyping:true}).data;

  return parsed
    .filter(r => r.Time && (r.coinbase || r.others))
    .map(r => ({
      date: new Date(r.Time.split(' ')[0] + "T00:00:00Z"),
      price: r.coinbase ?? r.others
    }))
    .sort((a,b) => a.date - b.date);
}

/* Slice data by date range selected in the UI */
function filterByDate(startISO, endISO) {
  const s = new Date(startISO + "T00:00:00Z");
  const e = new Date(endISO   + "T23:59:59Z");
  return fullData.filter(d => d.date >= s && d.date <= e);
}

/* Build vertical-line annotations for halvings that fall inside the range */
function buildHalvingAnnotations(rangeDates) {
  const [start,end] = [rangeDates[0], rangeDates[rangeDates.length-1]];
  return HALVING_DATES.filter(d => d>=start && d<=end).map(d => ({
    type:'line',scaleID:'x',value:d,borderColor:'#ff8c00',borderWidth:1,
    label:{content:'Halving',enabled:true,position:'start',color:'#ff8c00'}
  }));
}

/* Core chart factory */
function createChart(ctx, cfg){ return new Chart(ctx, cfg); }

/* ──────────────────────────────────────────────────────────
   1.  INITIALISE EVERYTHING AFTER DOM LOAD
─────────────────────────────────────────────────────────── */
document.addEventListener('DOMContentLoaded', async () => {
  /* Theme toggle (existing logic unchanged) */
  const themeToggle = document.getElementById('theme-toggle');
  const themeIcon   = document.getElementById('theme-icon');
  themeToggle.addEventListener('click', () => {
     document.documentElement.classList.toggle('dark');
     const icn = document.documentElement.classList.contains('dark')?'fa-moon':'fa-sun';
     themeIcon.className='fas '+icn; localStorage.setItem('theme',icn==='fa-moon'?'dark':'light');
     repaintCharts();
  });
  if(localStorage.getItem('theme')==='light'|| (window.matchMedia('(prefers-color-scheme: light)').matches&&!localStorage.getItem('theme'))){
     document.documentElement.classList.remove('dark'); themeIcon.className='fas fa-sun';
  }

  /* Default date range: last year */
  const today  = new Date().toISOString().split('T')[0];
  const yearAgo= new Date(); yearAgo.setFullYear(yearAgo.getFullYear()-1);
  const yearAgoStr = yearAgo.toISOString().split('T')[0];
  document.getElementById('end-date').value=today;
  document.getElementById('start-date').value=yearAgoStr;

  /* Fetch dataset once */
  try{
     fullData = await fetchBTCData();
  }catch(e){
     alert("Could not load Bitcoin price data. See console.");
     console.error(e);
     return;
  }

  /* Build charts */
  buildCharts();

  /* Wire up UI interactions */
  ['start-date','end-date','plot-type'].forEach(id =>
     document.getElementById(id).addEventListener('change', updateCharts));
  document.querySelectorAll('input[name="scale"]').forEach(el =>
     el.addEventListener('change', updateCharts));

  /* Investment-sim button keeps using the latest btcPrice (ticker) – left unchanged */
  // (existing `run-sim` click handler could stay; you may adapt if needed)
});

/* ──────────────────────────────────────────────────────────
   2.  CHART CONSTRUCTION + UPDATES
─────────────────────────────────────────────────────────── */
function buildCharts(){
  const theme = getCurrentTheme();
  const {labels, prices} = sliceForCurrentRange();

  /* MAIN */
  const mainCtx = document.getElementById('main-graph').getContext('2d');
  mainChart = createChart(mainCtx,{
    type:'line',
    data:{
      labels, datasets:[{
        label:'Bitcoin Price (USD)',data:prices,borderColor:theme.primary,
        backgroundColor:'rgba(13,110,253,.1)',borderWidth:2,tension:.1,fill:true
      }]
    },
    options:{
      responsive:true,maintainAspectRatio:false,
      plugins:{
        annotation:{annotations:buildHalvingAnnotations(labels)},
        legend:{display:false},
        tooltip:{mode:'index',intersect:false,
          callbacks:{label:c=>"Bitcoin: $"+c.raw.toLocaleString()}
        }
      },
      scales:{
        x:{type:'time',time:{unit:'month'},
           grid:{color:theme.gridColor},ticks:{color:theme.textColor}},
        y:{beginAtZero:false,
           grid:{color:theme.gridColor},ticks:{color:theme.textColor,
             callback:v=>'$'+v.toLocaleString()}}
      }
    }
  });

  /* SECONDARY (Deviation initially) */
  const secondaryCtx = document.getElementById('secondary-graph').getContext('2d');
  const deviations = prices.map((p,i)=>((p-(30000+i*20))/(30000+i*20))*100);
  secondaryChart = createChart(secondaryCtx,{
    type:'line',
    data:{labels,
      datasets:[{label:'Deviation from Trend (%)',data:deviations,
        borderColor:theme.warning,backgroundColor:'rgba(255,193,7,.1)',borderWidth:2,
        tension:.1,fill:true}]},
    options:{
      responsive:true,maintainAspectRatio:false,
      plugins:{legend:{display:false},tooltip:{mode:'index',intersect:false,
        callbacks:{label:c=>c.dataset.label+': '+c.raw.toFixed(2)+'%'}}},
      scales:{
        x:{type:'time',time:{unit:'month'},grid:{color:theme.gridColor},
           ticks:{color:theme.textColor}},
        y:{beginAtZero:true,grid:{color:theme.gridColor},
           ticks:{color:theme.textColor,callback:v=>v+'%'}}
      }
    }
  });

  /* SIM chart keeps demo data – you can replace similarly */
  simChart = new Chart(document.getElementById('sim-graph'),{
    type:'line',data:{labels, datasets:[/* ... same as before ... */]},options:{/* ... */}
  });
}

/* Helper to slice the global dataset for current date range */
function sliceForCurrentRange(){
  const s = document.getElementById('start-date').value;
  const e = document.getElementById('end-date').value;
  const range = filterByDate(s,e);
  return {
    labels: range.map(d=>d.date),
    prices: range.map(d=>d.price)
  };
}

/* Re-paint / update theme colors when toggling dark–light */
function repaintCharts(){
  const theme = getCurrentTheme();
  [mainChart,secondaryChart,simChart].forEach(ch=>{
    if(!ch) return;
    ch.options.scales.x.grid.color = theme.gridColor;
    ch.options.scales.y.grid.color = theme.gridColor;
    ch.options.scales.x.ticks.color= theme.textColor;
    ch.options.scales.y.ticks.color= theme.textColor;
    if(ch === mainChart){
      ch.data.datasets[0].borderColor = theme.primary;
      ch.options.plugins.annotation.annotations =
        buildHalvingAnnotations(ch.data.labels);
    }else if(ch===secondaryChart){
      ch.data.datasets[0].borderColor = theme.warning;
      ch.data.datasets[0].backgroundColor='rgba(255,193,7,.1)';
    }
    ch.update();
  });
}

/* Called whenever date range / plot type / scale changes */
function updateCharts(){
  const plotType = document.getElementById('plot-type').value;
  const scaleType= document.querySelector('input[name="scale"]:checked').value;
  const theme    = getCurrentTheme();
  const {labels, prices} = sliceForCurrentRange();

  /* MAIN series update */
  mainChart.data.labels = labels;
  mainChart.data.datasets[0].data = prices;
  mainChart.options.scales.y.type = (scaleType==='log-log')?'logarithmic':'linear';
  mainChart.options.plugins.annotation.annotations =
      buildHalvingAnnotations(labels);

  /* SECONDARY varies by plot type */
  let secondaryData, secondaryLabel, bg, border;
  if(plotType==='deviation' || plotType==='log'){
    secondaryLabel='Deviation from Trend (%)';
    secondaryData = prices.map((p,i)=>{
      const trend = 30000 + i*20;
      return ((p-trend)/trend)*100;
    });
    bg='rgba(255,193,7,.1)'; border=theme.warning;
    secondaryChart.options.scales.y.ticks.callback=v=>v+'%';
  }else if(plotType==='4yr'){
    secondaryLabel='4-Year Moving Average';
    secondaryData = prices.map((_,i)=>{
      const from = Math.max(0,i-365*4);
      const slice = prices.slice(from,i+1);
      return slice.reduce((a,b)=>a+b,0)/slice.length;
    });
    bg='rgba(25,135,84,.1)'; border=theme.success;
    secondaryChart.options.scales.y.ticks.callback=v=>'$'+v.toLocaleString();
  }else{ /* default: show raw price again */
    secondaryLabel='Historical Price';
    secondaryData = prices; bg='rgba(13,110,253,.1)'; border=theme.primary;
    secondaryChart.options.scales.y.ticks.callback=v=>'$'+v.toLocaleString();
  }
  secondaryChart.data.labels = labels;
  Object.assign(secondaryChart.data.datasets[0],{
    label:secondaryLabel,data:secondaryData,
    backgroundColor:bg,borderColor:border
  });

  /* Update & redraw */
  mainChart.update(); secondaryChart.update();
}
</script>
</body>
</html>
